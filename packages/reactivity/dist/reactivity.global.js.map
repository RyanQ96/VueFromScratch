{
  "version": 3,
  "sources": ["../src/index.ts", "../src/effect.ts", "../../shared/src/index.ts", "../src/baseHandler.ts", "../src/reactive.ts", "../src/computed.ts", "../src/watch.ts", "../src/ref.ts"],
  "sourcesContent": ["export { effect } from \"./effect\"\nexport { reactive } from \"./reactive\"\nexport { computed } from \"./computed\"\nexport { watch } from \"./watch\"\nexport { ref } from \"./ref\"", "export let activeEffect = undefined\nexport class ReactiveEffect {\n  public active = true\n  public fn\n  public parent = null\n  public deps = new Set()\n  constructor(fn, public scheduler?) { //\u4F20\u9012\u7684fn\u4F1A\u88AB\u653E\u5728fn\u4E0A\n    this.fn = fn\n  }\n  run() {\n    if (!this.active) {\n      return this.fn()\n    } else {\n      // dependencies tracking \n      try {\n        cleanEffect(this)\n        this.parent = activeEffect\n        activeEffect = this\n        return this.fn()\n      } finally {\n        activeEffect = this.parent\n        this.parent = null\n      }\n    }\n  }\n  stop() {\n    if (this.active) {\n      this.active = false\n      cleanEffect(this)\n    }\n  }\n}\n\n\nexport function cleanEffect(effect){ \n  console.log('effect cleaned')\n  effect.deps.forEach(deps => {\n    deps.delete(effect)\n  })\n  effect.deps.clear()\n}\n\nexport function effect(fn, options = {} as any) {\n  const _effect = new ReactiveEffect(fn, options.scheduler)\n  _effect.run()\n  const runner = _effect.run.bind(_effect)\n  runner.effect = _effect //expose effect instance \n  return runner // User can mannually stop collect and runner \n}\n\nconst targetMap = new WeakMap()\n// map {object: {key: [effect, effect2....]}}\nexport function track(target, key) {\n  if (activeEffect) {\n    let depsMap = targetMap.get(target)\n    if (!depsMap) {\n      targetMap.set(target, (depsMap = new Map()))\n    }\n    let deps = depsMap.get(key)\n    if (!deps) {\n      depsMap.set(key, (deps = new Set()))\n    }\n    trackEffect(deps)\n  }\n}\n\nexport function trackEffect(deps) {\n  const shouldTrack = !deps.has(activeEffect)\n    if (shouldTrack) {\n      deps.add(activeEffect)\n      if (!activeEffect.deps.has(deps)) {\n        activeEffect.deps.add(deps)\n      }\n    }\n}\n\nexport function trigger(target, key, value) {\n  let depsMap = targetMap.get(target)\n  if (!depsMap) return  // key doesn't reply on any effect \n  const effects = depsMap.get(key)\n  triggerEffects(effects)\n}\n\nexport function triggerEffects(effects) {\n  effects && Array.from(effects).forEach((effect: ReactiveEffect) => {\n    if (effect !== activeEffect) {\n      if (effect.scheduler) {\n        effect.scheduler()\n      } else {\n        effect.run()\n      }\n    } // re-execute effect\n  })\n}", "export const isObject = (value) => {\n  return typeof value === 'object' && value !== null\n}\n\nexport const isFunction = (value) => {\n  return typeof value === 'function' && value != null \n}\n\nexport const isArray = (value) => {\n  return value != null && Array.isArray(value) \n}", "import { track, trigger } from \"./effect\";\nimport { reactive } from \"./reactive\"\nimport { isObject } from \"@vue/shared\";\nexport const enum  ReactiveFlags {\n  IS_REACTIVE = '__v_isReactive'\n}\nexport const baseHandler = {\n  get(target, key, receiver) {\n    if (key === ReactiveFlags.IS_REACTIVE) {\n      return true\n    } else {\n      // relate key and effect\n      track(target, key)\n      // console.log(`logging: collect dependency for key: ${String(key)}`)\n      // lazy proxy \n      let res = Reflect.get(target, key, receiver)\n      if (isObject(res)) {\n        return reactive(res)\n      } else {\n        return res\n      }\n    }\n  },\n  set(target, key, value, receiver) {\n    // based on key, find which effects need to change \n    let oldValue = target[key] \n    if (oldValue != value) {\n      let result = Reflect.set(target, key, value, receiver)\n      trigger(target, key, value) \n      return result; \n    }\n  }\n} \n", "import { isObject } from \"@vue/shared\";\nimport { activeEffect } from \"./effect\";\nimport { baseHandler, ReactiveFlags } from \"./baseHandler\";\nconst reactiveMap = new WeakMap(); // key of weakmap has to be an object\n// v8's gabage collection mechanism \n\nexport function reactive(target) {\n  if (!isObject(target)) {\n    return target\n  }\n\n  if (target[ReactiveFlags.IS_REACTIVE]) {\n    return target\n  }\n\n  const existing = reactiveMap.get(target)\n  if (existing) {\n    return existing\n  }\n\n  const proxy = new Proxy(target, baseHandler)\n\n  reactiveMap.set(target, proxy)\n  return proxy\n}\n\nexport function isReactive(object) {\n  return !!(object && object[ReactiveFlags.IS_REACTIVE])\n}", "import { isObject, isFunction } from \"@vue/shared\";\nimport { ReactiveEffect, trackEffect, triggerEffects } from \"./effect\";\n\n\nclass ComputedRefImpl { // computed basically is an effect\n  private _value\n  private _dirty = true\n  private _effect\n  public deps = new Set()\n  constructor(public getter, public setter) {\n    this._effect = new ReactiveEffect(getter, ()=>{\n      if (!this._dirty) {\n        this._dirty = true\n        // notify collected effects to re-run\n        triggerEffects(this.deps)\n      }\n    })\n  }\n  get value() {\n    trackEffect(this.deps)\n    if (this._dirty) {\n      this._value = this._effect.run() \n      this._dirty = false\n    }\n    return this._value\n  }\n  set value(newValue) {\n    this.setter(newValue) \n  }\n}\n\nexport function computed(getterOrOptions) {\n  let getter\n  let setter\n  let isGetter = isFunction(getterOrOptions) \n  const fn = () => console.warn('computed is read only')\n  if (isGetter) {\n    getter = getterOrOptions\n    setter = () => fn \n  } else {\n    getter = getterOrOptions.getter \n    setter = getterOrOptions.setter || fn\n  }\n  return new ComputedRefImpl(getter, setter)\n}", "import { isObject, isFunction } from \"@vue/shared\";\nimport { isReactive } from \"./reactive\";\nimport { ReactiveEffect } from \"./effect\";\nfunction traverse(value, set = new Set()) {\n  if (!isObject) return value\n  if (set.has(value)) return\n  set.add(value)\n  for (let key in value) {\n    traverse(value[key], set)\n  }\n  return value\n}\n\nexport function watch(source, cb) {\n  let getter;\n  if (isReactive(source)) {\n    getter = () => traverse(source)\n  } else if (isFunction(source)) {\n    getter = source\n  } else {\n    console.warn(\"source is not an reactive object or a function\")\n    return\n  }\n  let oldValue\n  let waiting = false\n  const job = () => {\n    if (!waiting) {\n      waiting = true\n      Promise.resolve().then(() => {\n        const newValue = effect.run()\n        cb(newValue, oldValue)\n        oldValue = newValue\n        waiting = false\n      })\n    }\n  }\n  const effect = new ReactiveEffect(getter, job);\n  oldValue = effect.run()\n}", "import { isArray, isObject } from \"@vue/shared\";\nimport { reactive } from \"./reactive\"\nimport { trackEffect, triggerEffects } from \"./effect\";\n\nfunction toReactive(value) {\n  return isObject(value) ? reactive(value) : value\n}\n\nclass RefImpl {\n  public deps = new Set()\n  public _value\n  public rawValue\n  constructor(value) {\n    this._value = toReactive(value)\n    this.rawValue = value\n  }\n  get value() {\n    trackEffect(this.deps)\n    return this._value\n  }\n  set value(newVal) {\n    if(newVal !== this._value) {\n      this._value = toReactive(newVal)\n      this.rawValue = newVal\n      triggerEffects(this.deps)\n    }\n  }\n}\n\n\nclass ObjectRefImpl {\n  constructor(public object, public key) {}\n  get value() {\n    return this.object[this.key]\n  }\n  set value(newVal) {\n    this.object[this.key] = newVal\n  }\n}\n\nexport function ref(val) {\n  return new RefImpl(val)    \n}\n\nexport function toRef(target, key) {\n  return new ObjectRefImpl(target, key) \n}\n\nexport function toRefs(object) {\n  let result = isArray(object) ? new Array(object.length) : {}\n  for (let key in object) {\n    result[key] = toRef(object, key) \n  }\n  return result\n}"],
  "mappings": "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",
  "names": ["effect", "effect"]
}
